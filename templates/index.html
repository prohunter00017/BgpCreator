{% extends "base.html" %}

{% block extra_head %}
<!-- FAQ Schema for SEO -->
{% if faq_schema is defined and faq_schema %}
<script type="application/ld+json">
{{ faq_schema | tojson | safe }}
</script>
{% endif %}

<!-- SoftwareApplication Schema for SEO (global or per-game override) -->
{% if software_schema is defined and software_schema %}
<script type="application/ld+json">
{{ software_schema | tojson | safe }}
</script>
{% elif software_application_schema is defined and software_application_schema %}
<script type="application/ld+json">
{{ software_application_schema | tojson | safe }}
</script>
{% endif %}

<!-- Breadcrumb Schema for SEO -->
{% if breadcrumb_schema is defined and breadcrumb_schema and breadcrumb_schema.itemListElement %}
<script type="application/ld+json">
{{ breadcrumb_schema | tojson | safe }}
</script>
{% endif %}
{% endblock %}

{% block extra_css %}
/* Essential above-the-fold styles for immediate rendering */
.frame-wrap {
  position: relative;
  min-height: 600px;
  aspect-ratio: 16/9;
}
.overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.7);
  z-index: 3;
}
body.playing {
  overflow: hidden;
}
.frame-wrap.fullscreen {
  position: fixed;
  inset: 0;
  z-index: 9999;
  border-radius: 0;
  border: 0;
}
{% endblock %}

{% block content %}

{% if page_navigation %}
<nav aria-label="On this page" style="margin:1rem 0">
  <strong style="display:block;margin-bottom:.25rem;font-size:.95rem">On this page</strong>
  <ul style="list-style:none;display:flex;flex-wrap:wrap;gap:.5rem;padding:0;margin:0">
    {% for nav_item in page_navigation %}
    <li><a class="nav-link" href="#{{ nav_item.anchor }}">{{ nav_item.title }}</a></li>
    {% endfor %}
  </ul>
</nav>
{% endif %}

{% include 'game-iframe.html' %}

<!-- Content Split Container for Desktop -->
<div class="content-split-container">
  <div class="article-content-section">
    {% include 'article-content.html' %}
  </div>
  <div class="games-widget-section">
    {% include 'games-widget.html' %}
  </div>
</div>


{% if cookie_banner %}
<div id="cookie-banner">
  <p>{{ cookie_banner.message }}</p>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn" onclick="acceptCookies()">{{ cookie_banner.accept_text }}</button>
    <button class="btn secondary" onclick="declineCookies()">{{ cookie_banner.decline_text }}</button>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if game_embed %}
<script>
// Game loading functionality - Optimized for performance
document.addEventListener('DOMContentLoaded', () => {
  const playBtn = document.getElementById('play-btn');
  const gameFrame = document.getElementById('game-frame');
  const frameWrap = document.querySelector('.frame-wrap');
  const overlay = document.getElementById('overlay');
  const exitBtn = document.getElementById('exit-full');

  // All available games for the widget
  const allGames = {{ games | tojson | safe if games is defined else '[]' }};
  const currentGameSlug = '{{ page_key if page_key is defined else "" }}';
  

  // Function to load a game (used by games widget)
  window.loadGame = function(gameUrl) {
    if (gameFrame && overlay && frameWrap) {
      // Add fullscreen class first
      frameWrap.classList.add('fullscreen');
      // Load the game URL
      gameFrame.src = gameUrl;
      // Hide overlay and add playing class
      overlay.style.display = 'none';
      document.body.classList.add('playing');
      
      // Scroll to top to show the game
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  // Game loading functionality
  if (playBtn && gameFrame) {
    playBtn.addEventListener('click', (e) => {
      // Prevent default action (no navigation)
      e.preventDefault();
      e.stopPropagation();
      
      // Add fullscreen class first
      frameWrap.classList.add('fullscreen');
      // Load the game URL from data attribute
      const gameUrl = playBtn.dataset.gameUrl;
      gameFrame.src = gameUrl;
      // Hide overlay and add playing class
      overlay.style.display = 'none';
      document.body.classList.add('playing');
      
      // Ensure exit button is visible
      if (exitBtn) {
        exitBtn.style.display = 'inline-flex';
      }
    });
  }

  // Exit fullscreen functionality
  if (exitBtn) {
    exitBtn.addEventListener('click', () => {
      // Remove fullscreen and playing classes
      document.body.classList.remove('playing');
      frameWrap.classList.remove('fullscreen');
      // Clear the iframe src to stop the game
      if (gameFrame) {
        gameFrame.src = '';
      }
      // Show the overlay again
      if (overlay) {
        overlay.style.display = '';
      }
    });
  }

  // ESC key to exit fullscreen
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.body.classList.contains('playing')) {
      // Remove fullscreen and playing classes
      document.body.classList.remove('playing');
      frameWrap.classList.remove('fullscreen');
      // Clear the iframe src to stop the game
      if (gameFrame) {
        gameFrame.src = '';
      }
      // Show the overlay again
      if (overlay) {
        overlay.style.display = '';
      }
    }
  });


});
</script>
{% endif %}

{% if cookie_banner %}
<script>
// Cookie banner functionality - Optimized for performance
function acceptCookies() {
  localStorage.setItem('consent', 'yes');
  const banner = document.getElementById('cookie-banner');
  if (banner) {
    requestAnimationFrame(() => {
      banner.style.display = 'none';
    });
  }
}

function declineCookies() {
  localStorage.setItem('consent', 'no');
  const banner = document.getElementById('cookie-banner');
  if (banner) {
    requestAnimationFrame(() => {
      banner.style.display = 'none';
    });
  }
}

// Show banner if no consent stored - Optimized
document.addEventListener('DOMContentLoaded', () => {
  const consent = localStorage.getItem('consent');
  if (!consent) {
    const banner = document.getElementById('cookie-banner');
    if (banner) {
      requestAnimationFrame(() => {
        banner.style.display = 'block';
      });
    }
  }
});
</script>
{% endif %}

<!-- Main JavaScript file -->
<script src="/assets/js/main.js"></script>

{% endblock %}

