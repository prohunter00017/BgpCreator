<!doctype html>
<html lang="{{ language }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="locale" content="{{ locale }}">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>{{ page_title }} – {{ site_name }}</title>
  <meta name="description" content="{{ page_description }}">
  <link rel="canonical" href="{{ canonical_url }}">
  <meta name="robots" content="{{ robots_content }}">
  
  <!-- Core Web Vitals Optimizations -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="stylesheet" href="/templates/styles.css?v=2025012001">
  
  <!-- Optimize font loading -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
  
  <!-- Open Graph -->
  <meta property="og:type" content="{{ og_type }}">
  <meta property="og:site_name" content="{{ site_name }}">
  <meta property="og:title" content="{{ page_title }} – {{ site_name }}">
  <meta property="og:description" content="{{ page_description }}">
  <meta property="og:url" content="{{ canonical_url }}">
  <meta property="og:image" content="{{ site_url }}{{ og_image }}">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page_title }} – {{ site_name }}">
  <meta name="twitter:description" content="{{ page_description }}">
  <meta name="twitter:image" content="{{ site_url }}{{ og_image }}">

  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="{{ theme_color }}">
  
  <!-- Favicon links for different sizes and devices -->
  {% for favicon in favicon_links %}
  <link rel="{{ favicon.rel }}" type="{{ favicon.type }}"{% if favicon.sizes %} sizes="{{ favicon.sizes }}"{% endif %} href="{{ favicon.href }}">
  {% endfor %}

  <!-- External CSS only - no internal styles -->
  {% block extra_css %}{% endblock %}

  {% block extra_head %}{% endblock %}

  {% if organization_schema and organization_schema.name %}
  <!-- Schema.org JSON-LD - Organization Schema -->
  <script type="application/ld+json">
  {{ organization_schema | tojson | safe }}
  </script>
  {% endif %}
  
  {% if website_schema %}
  <!-- Schema.org JSON-LD - WebSite Schema -->
  <script type="application/ld+json">
  {{ website_schema | tojson | safe }}
  </script>
  {% endif %}
  
  <!-- Custom Head Code (Analytics, Pixels, etc.) -->
  {% if custom_head_code %}
  {{ custom_head_code | safe }}
  {% endif %}
  
  <!-- Ad Network Scripts (Add your Ezoic or Google AdSense scripts here) -->
  {% if ads_enabled %}
    {% if ad_networks.ezoic.enabled %}
      <!-- Ezoic Ad Script - Add your Ezoic script tag here -->
      <!-- Example: <script src="//www.ezoic.net/ezoic/sa.min.js"></script> -->
    {% elif ad_networks.google_adsense.enabled %}
      <!-- Google AdSense Script -->
      <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{ ad_networks.google_adsense.publisher_id }}" crossorigin="anonymous"></script> -->
    {% endif %}
  {% endif %}
  
  <!-- Google Analytics -->
  {% if google_analytics_code %}
  {{ google_analytics_code | safe }}
  {% endif %}
  
</head>
<body>
  <!-- Custom Body Code (Widgets, Popups, etc.) -->
  {% if custom_body_code %}
  {{ custom_body_code | safe }}
  {% endif %}
  
  <a class="skip-link" href="#content">Skip to content</a>
  <header role="banner">
    <div class="container">
      <div class="header-inner">
        <!-- Logo -->
        <a href="{% if current_page == 'index' %}{{ site_url.rstrip('/') }}{% else %}/index.html{% endif %}" class="logo" {% if current_page == 'index' %}aria-current="page"{% endif %}>
          <img src="/logo.png" alt="{{ site_name }}">
          <span class="logo-text">{{ site_name }}</span>
        </a>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="navigation">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
          </svg>
        </button>
        
        <!-- Navigation -->
        <nav id="navigation" aria-label="Primary">
          <ul class="nav-menu">
            {% for nav_item in navigation[:5] %}
            <li><a href="{{ nav_item.url }}" {% if current_page == nav_item.key %}aria-current="page"{% endif %}>{{ nav_item.title }}</a></li>
            {% endfor %}
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main id="content" class="container" role="main">
    <div class="main-layout">
      {% block content %}{% endblock %}
    </div>
  </main>
  
  <footer role="contentinfo" class="container">
    <small>© <span id="year">{{ current_year }}</span> {{ site_domain }} · 
    {% for footer_link in footer_links %}
    <a href="{{ footer_link.url }}">{{ footer_link.title }}</a>{% if not loop.last %} · {% endif %}
    {% endfor %}
    </small>
  </footer>
  
  <!-- escaperoad.io back-to-top button -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top" title="Back to top">
    ↑
  </button>
  
  <script defer>
  document.addEventListener('DOMContentLoaded',()=>{
    const y=document.getElementById('year'); 
    if(y) y.textContent=new Date().getFullYear();
    
    // Simple mobile menu toggle
    const mobileToggle = document.querySelector('.mobile-toggle');
    const navMenu = document.querySelector('.nav-menu');
    
    if(mobileToggle && navMenu) {
      mobileToggle.addEventListener('click', () => {
        const isActive = navMenu.classList.contains('active');
        navMenu.classList.toggle('active');
        mobileToggle.setAttribute('aria-expanded', !isActive);
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if(!mobileToggle.contains(e.target) && !navMenu.contains(e.target)) {
          navMenu.classList.remove('active');
          mobileToggle.setAttribute('aria-expanded', 'false');
        }
      });
      
      // Close menu on Escape key
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && navMenu.classList.contains('active')) {
          navMenu.classList.remove('active');
          mobileToggle.setAttribute('aria-expanded', 'false');
        }
      });
    }


    // escaperoad.io back-to-top button functionality
    const backToTop = document.getElementById('backToTop');
    if(backToTop) {
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
          backToTop.classList.add('show');
        } else {
          backToTop.classList.remove('show');
        }
      });
      
      backToTop.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    }
  });
  </script>
  
  <!-- Form message function -->
  <script>
  function showMessage(message) {
    const messageDiv = document.getElementById('form-message');
    if (messageDiv) {
      messageDiv.textContent = message;
      // Use requestAnimationFrame to avoid forced reflow
      requestAnimationFrame(() => {
        messageDiv.style.display = 'block';
      });
      // Hide message after 5 seconds - also optimized
      setTimeout(() => {
        requestAnimationFrame(() => {
          messageDiv.style.display = 'none';
        });
      }, 5000);
    }
  }
  </script>
  
  <!-- Global UI State Reset - Prevents glitches when navigating between pages -->
  <script>
  (function() {
    'use strict';
    
    // Reset UI state on page load to prevent glitches
    function resetUIState() {
      // Remove any game-related classes that might persist across navigation
      document.body.classList.remove('playing');
      
      // Reset any fullscreen wrappers that might be stuck
      const frameWraps = document.querySelectorAll('.frame-wrap');
      frameWraps.forEach(wrap => {
        wrap.classList.remove('fullscreen');
      });
      
      // Ensure body can scroll normally
      document.body.style.overflow = '';
      
      // Hide any exit buttons that might be visible
      const exitButtons = document.querySelectorAll('.exit-btn');
      exitButtons.forEach(btn => {
        btn.style.display = '';
      });
      
      // Hide any game controls that might be visible
      const gameControls = document.querySelectorAll('#game-controls');
      gameControls.forEach(controls => {
        controls.style.display = 'none';
      });
    }
    
    // Run on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resetUIState);
    } else {
      resetUIState();
    }
    
    // Cleanup when navigating away (for SPA-like behavior)
    window.addEventListener('beforeunload', resetUIState);
    
    // Also reset on page show (handles back/forward navigation)
    window.addEventListener('pageshow', resetUIState);
  })();
  </script>
  
  {% block extra_js %}{% endblock %}

<!-- Enterprise Mobile Optimizations -->
<script>
(function() {
  // Detect mobile device
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (isMobile) {
    // Add mobile class for CSS targeting
    document.documentElement.classList.add('mobile-device');
    
    // Prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
    
    // Optimize iframe for mobile when game is loaded
    window.addEventListener('DOMContentLoaded', function() {
      const iframe = document.getElementById('game-frame');
      if (iframe) {
        // Prevent scrolling within iframe on mobile
        iframe.style.touchAction = 'manipulation';
        iframe.setAttribute('scrolling', 'no');
        
        // Handle iframe load event
        iframe.addEventListener('load', function() {
          // Ensure iframe is properly sized on mobile
          if (window.innerWidth <= 768) {
            iframe.style.width = '100%';
            iframe.style.height = '100%';
          }
        });
      }
      
      // Optimize play button for mobile
      const playBtn = document.getElementById('play-btn');
      if (playBtn && window.innerWidth <= 480) {
        playBtn.style.touchAction = 'manipulation';
      }
    });
  }
})();
</script>
  
  <!-- Custom Footer Code (Analytics, Pixels, etc.) -->
  {% if custom_footer_code %}
  {{ custom_footer_code | safe }}
  {% endif %}
</body>
</html>

